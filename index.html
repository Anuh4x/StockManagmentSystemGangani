<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spare Part Stock Management</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon.ico" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    .top-bar {
      width: 100%;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .add-btn-overlay {
      position: absolute;
      top: -27px;
      left: 0px;
      z-index: 20;
      padding: 12px 22px;
      transform: translateY(-50%);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    }

    .btn {
      padding: 10px 20px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    .container {
      padding: 100px 20px 40px;
      max-width: 1100px;
      margin: auto;
    }

    .glass-card {
      margin-top: 12px;
      background: rgba(255, 255, 255, 0.55);
      backdrop-filter: blur(12px);
      padding: 34px 20px 28px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    /* Popup */
    .popup-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .popup {
      width: 90%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(15px);
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 4px 25px rgba(0, 0, 0, 0.2);
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #bbb;
      margin-top: 10px;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .cancel-btn {
      background: #888;
    }


    @media (max-width: 600px) {

  .glass-card {
    padding: 22px 12px;
  }

  th, td {
    font-size: 0.8rem;
    padding: 10px 6px;
  }

  /* Let table scroll horizontally on small screens */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  .add-btn-overlay {
    right: 10px;
    top: -27px;
    left: 5px;
    padding: 8px 14px;
    font-size: 0.85rem;
  }

  .btn {
    padding: 9px 14px;
    font-size: 0.9rem;
  }
}
  </style>
</head>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("Service Worker Registered"));
  }
</script>
<body>

  <div class="top-bar">
    <div class="logo" style="font-size:1.4rem; font-weight:bold;">Gangani Auto Electricals</div>
  </div>

  <div class="container">
    <div class="glass-card">

      <button class="btn add-btn-overlay" onclick="openPopup()">Add Item</button>

      <h2>Search Stock</h2>
      <input type="text" id="searchInput" placeholder="Search part name or number..." onkeyup="filterStock()" />

      <table>
        <thead>
          <tr>
            <th>Part No.</th>
            <th>Part Name</th>
            <th>Vehicle</th>
            <th>Stock</th>
            <th>Buy Price</th>
            <th>Sell Price</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="stockTable"></tbody>
      </table>

    </div>
  </div>

  <!-- Popup -->
  <div class="popup-bg" id="popupBg">
    <div class="popup">
      <h3 id="popupTitle">Add New Part</h3>

      <input type="text" id="pname" placeholder="Part Name" />
      <input type="text" id="vehicle" placeholder="Vehicle" />
      <input type="text" id="partno" placeholder="Part Number" />
      <input type="number" id="stock" placeholder="Stock Amount" />
      <input type="number" id="buy" placeholder="Buy Price" />
      <input type="number" id="sell" placeholder="Sell Price" />

      <div class="btn-row">
        <button class="btn" id="saveBtn" onclick="addItem()">Add Item</button>
        <button class="btn cancel-btn" onclick="closePopup()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      get,
      child,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBN9LWPP0tebZiCtXMAKatKivb5lX0g1_g",
      authDomain: "shopstock-d304a.firebaseapp.com",
      databaseURL: "https://shopstock-d304a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "shopstock-d304a",
      storageBucket: "shopstock-d304a.firebasestorage.app",
      messagingSenderId: "82450149368",
      appId: "1:82450149368:web:3772ec3a4d96d8c1ecf00d",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let editKey = null;

    // OPEN POPUP
    window.openPopup = function () {
      editKey = null;
      document.getElementById("popupTitle").innerText = "Add New Part";
      document.getElementById("saveBtn").innerText = "Add Item";
      document.querySelectorAll('.popup input').forEach(i => i.value = "");
      document.getElementById("popupBg").style.display = "flex";
    };

    // CLOSE POPUP
    window.closePopup = function () {
      document.getElementById("popupBg").style.display = "none";
    };

    // LOAD STOCK
    function loadStock() {
      const dbRef = ref(db, "stock");
      get(dbRef).then(snapshot => {
        if (snapshot.exists()) {
          displayStock(Object.entries(snapshot.val()));
        } else {
          displayStock([]);
        }
      });
    }
    loadStock();

    // ADD NEW ITEM
    window.addItem = function () {
      const item = {
        name: pname.value,
        vehicle: vehicle.value,
        partno: partno.value,
        stock: stock.value,
        buy: buy.value,
        sell: sell.value,
      };

      const newRef = push(ref(db, "stock"));
      set(newRef, item).then(() => {
        closePopup();
        loadStock();
      });
    }

    // EDIT ITEM â€” load values into popup
    window.editItem = function (key, item) {
      editKey = key;

      document.getElementById("popupTitle").innerText = "Edit Item";
      document.getElementById("saveBtn").innerText = "Save Changes";
      document.getElementById("saveBtn").onclick = saveEdit;

      pname.value = item.name;
      vehicle.value = item.vehicle;
      partno.value = item.partno;
      stock.value = item.stock;
      buy.value = item.buy;
      sell.value = item.sell;

      popupBg.style.display = "flex";
    };

    // SAVE EDITED ITEM
    function saveEdit() {
      const updatedItem = {
        name: pname.value,
        vehicle: vehicle.value,
        partno: partno.value,
        stock: stock.value,
        buy: buy.value,
        sell: sell.value,
      };

      update(ref(db, "stock/" + editKey), updatedItem).then(() => {
        closePopup();
        loadStock();
      });
    }

    // DELETE ITEM
    window.deleteItem = function (key) {
      remove(ref(db, "stock/" + key)).then(() => loadStock());
    };

    // DISPLAY STOCK TABLE
    function displayStock(items) {
      const table = document.getElementById("stockTable");
      table.innerHTML = "";

      items.forEach(([key, item]) => {
        table.innerHTML += `
          <tr>
            <td>${item.partno}</td>
            <td>${item.name}</td>
            <td>${item.vehicle}</td>
            <td>${item.stock}</td>
            <td>${item.buy}</td>
            <td>${item.sell}</td>
            <td style="display:flex; gap:15px;">

              <!-- EDIT ICON -->
              <img
                width="22"
                style="cursor:pointer"
                onclick='editItem("${key}", ${JSON.stringify(item)})'
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23007bff' viewBox='0 0 24 24'%3E%3Cpath d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z'/%3E%3C/svg%3E"
              />

              <!-- DELETE ICON -->
              <img
                width="22"
                style="cursor:pointer"
                onclick='deleteItem("${key}")'
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc3545'%3E%3Cpath d='M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-9l-1 1H5v2h14V4z'/%3E%3C/svg%3E"
              />

            </td>
          </tr>
        `;
      });
    }

    // SEARCH
    window.filterStock = function () {
      const text = searchInput.value.toLowerCase();

      const dbRef = ref(db, "stock");

      get(dbRef).then(snapshot => {
        if (!snapshot.exists()) return;

        const all = Object.entries(snapshot.val());
        const filtered = all.filter(([key, i]) =>
          i.name.toLowerCase().includes(text) ||
          i.partno.toLowerCase().includes(text)
        );

        displayStock(filtered);
      });
    };

  </script>

</body>

</html>
